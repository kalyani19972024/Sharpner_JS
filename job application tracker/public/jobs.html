<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Applications</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Job Application Tracker</h2>

  <!-- Job Form -->
  <form id="jobForm" enctype="multipart/form-data">
    <input type="hidden" id="jobId" name="jobId">

    <input type="text" id="companyName" name="companyName" placeholder="Company Name" required><br>
    <input type="text" id="jobTitle" name="jobTitle" placeholder="Job Title" required><br>
    <input type="date" id="applicationDate" name="applicationDate" required><br>

    <select id="status" name="status">
      <option value="Applied">Applied</option>
      <option value="Interviewed">Interviewed</option>
      <option value="Offered">Offered</option>
      <option value="Rejected">Rejected</option>
    </select><br>

    <textarea id="notes" name="notes" placeholder="Notes"></textarea><br>

    <input type="file" id="attachment" name="attachment" accept=".pdf,.doc,.docx"><br>

    <button type="submit">Save Application</button>
  </form>

  <h3>Your Applications</h3>
  <ul id="jobList"></ul>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // const token = localStorage.getItem("token");
    // const jobForm = document.getElementById("jobForm");
    // const jobIdInput = document.getElementById("jobId");
    // const jobList = document.getElementById("jobList");

    // // Load jobs and reminders
    // async function loadJobs() {
    //   try {
    //     const [jobsRes, remindersRes] = await Promise.all([
    //       axios.get("http://localhost:3000/api/jobs", {
    //         headers: { Authorization: `Bearer ${token}` }
    //       }),
    //       axios.get("http://localhost:3000/api/reminders", {
    //         headers: { Authorization: `Bearer ${token}` }
    //       })
    //     ]);

    //     const jobs = jobsRes.data;
    //     const reminders = remindersRes.data;

    //     jobList.innerHTML = "";
    //     jobs.forEach(job => {
    //       const li = document.createElement("li");

    //       // Find reminder linked to this job (if any)
    //       const jobReminders = reminders.filter(r => r.jobId === job.id);

    //       li.innerHTML = `
    //         <strong>${job.companyName}</strong> - ${job.jobTitle} (${job.status})
    //         <br>üìÖ Applied: ${new Date(job.applicationDate).toLocaleDateString()}
    //         ${job.attachment ? `<br><a href="http://localhost:3000/${job.attachment}" target="_blank">üìé Attachment</a>` : ""}
    //         <br><button onclick="toggleReminderForm(${job.id})">‚è∞ Add Reminder</button>
    //         <div id="reminder-form-${job.id}" style="display:none; margin-top:5px;">
    //           <input type="datetime-local" id="reminder-date-${job.id}" />
    //           <input type="text" id="reminder-note-${job.id}" placeholder="Reminder note" />
    //           <button onclick="saveReminder(${job.id})">Save</button>
    //           <button onclick="toggleReminderForm(${job.id})">Cancel</button>
    //         </div>
    //       `;

    //       // Existing reminders
    //       if (jobReminders.length > 0) {
    //         const ul = document.createElement("ul");
    //         jobReminders.forEach(rem => {
    //           const remLi = document.createElement("li");
    //           remLi.innerHTML = `
    //             ‚è∞ ${new Date(rem.reminderDate).toLocaleString()} - ${rem.note || ""}
    //             <button onclick="deleteReminder(${rem.id})">‚ùå</button>
    //           `;
    //           ul.appendChild(remLi);
    //         });
    //         li.appendChild(ul);
    //       }

    //       jobList.appendChild(li);
    //     });
    //   } catch (err) {
    //     console.error("Error loading jobs/reminders:", err);
    //   }
    // }
    
    // // Toggle reminder form
    // function toggleReminderForm(jobId) {
    //   const div = document.getElementById(`reminder-form-${jobId}`);
    //   div.style.display = div.style.display === "none" ? "block" : "none";
    // }

    // // Save reminder
    // function saveReminder(jobId) {
    //   const reminderDate = document.getElementById(`reminder-date-${jobId}`).value;
    //   const note = document.getElementById(`reminder-note-${jobId}`).value;

    //   if (!reminderDate) {
    //     alert("Please select a date/time!");
    //     return;
    //   }

    //   axios.post("http://localhost:3000/api/reminders", { jobId, reminderDate, note }, {
    //     headers: { Authorization: `Bearer ${token}` }
    //   }).then(() => {
    //     alert("Reminder set!");
    //     loadJobs();
    //   }).catch(err => {
    //     console.error("Reminder error:", err.response?.data || err.message);
    //     alert("Failed to set reminder");
    //   });
    // }
   
    // // Delete reminder
    // function deleteReminder(reminderId) {
    //   if (!confirm("Delete this reminder?")) return;

    //   axios.delete(`http://localhost:3000/api/reminders/${reminderId}`, {
    //     headers: { Authorization: `Bearer ${token}` }
    //   }).then(() => {
    //     alert("Reminder deleted!");
    //     loadJobs();
    //   }).catch(err => {
    //     console.error("Delete reminder error:", err);
    //     alert("Failed to delete reminder");
    //   });
    // }

    // // Save / Update Job
    // jobForm.addEventListener("submit", async (e) => {
    //   e.preventDefault();

    //   const jobId = jobIdInput.value;
    //   const formData = new FormData(jobForm);

    //   try {
    //     if (jobId) {
    //       await axios.put(`http://localhost:3000/api/jobs/${jobId}`, formData, {
    //         headers: { Authorization: `Bearer ${token}`, "Content-Type": "multipart/form-data" }
    //       });
    //       alert("Job updated!");
    //     } else {
    //       await axios.post("http://localhost:3000/api/jobs", formData, {
    //         headers: { Authorization: `Bearer ${token}`, "Content-Type": "multipart/form-data" }
    //       });
    //       alert("Job saved!");
    //     }
    //     resetForm();
    //     loadJobs();
    //   } catch (err) {
    //     console.error("Save error:", err.response?.data || err.message);
    //     alert("Error saving job application");
    //   }
    // });

    // function resetForm() {
    //   jobForm.reset();
    //   jobIdInput.value = "";
    // }

    // // Init
    // loadJobs();

     const token = localStorage.getItem("token");
  const jobForm = document.getElementById("jobForm");
  const jobIdInput = document.getElementById("jobId");
  const jobList = document.getElementById("jobList");

  // Load jobs and reminders
  async function loadJobs() {
    try {
      const [jobsRes, remindersRes] = await Promise.all([
        axios.get("http://localhost:3000/api/jobs", {
          headers: { Authorization: `Bearer ${token}` }
        }),
        axios.get("http://localhost:3000/api/reminders", {
          headers: { Authorization: `Bearer ${token}` }
        })
      ]);

      const jobs = jobsRes.data;
      const reminders = remindersRes.data;

      jobList.innerHTML = "";
      jobs.forEach(job => {
        const li = document.createElement("li");

        // Find reminder linked to this job (if any)
        const jobReminders = reminders.filter(r => r.jobId === job.id);

        li.innerHTML = `
          <strong>${job.companyName}</strong> - ${job.jobTitle} (${job.status})<br>
          üìÖ Applied: ${new Date(job.applicationDate).toLocaleDateString()}<br>
          ${job.attachment ? `<a href="http://localhost:3000/${job.attachment}" target="_blank">üìé Attachment</a><br>` : ""}
          <button onclick="toggleReminderForm(${job.id})">‚è∞ Set Reminder</button>

          <div id="reminder-form-${job.id}" style="display:none; margin-top:5px;">
            <input type="datetime-local" id="reminder-date-${job.id}" />
            <input type="text" id="reminder-note-${job.id}" placeholder="Reminder note" />
            <button onclick="saveReminder(${job.id})">Save</button>
            <button onclick="toggleReminderForm(${job.id})">Cancel</button>
          </div>
        `;

        // Existing reminders
        if (jobReminders.length > 0) {
          const ul = document.createElement("ul");
          jobReminders.forEach(rem => {
            const remLi = document.createElement("li");
            remLi.innerHTML = `
              ‚è∞ ${new Date(rem.reminderDate).toLocaleString()} - ${rem.note || ""}
              <button onclick="deleteReminder(${rem.id})">‚ùå</button>
            `;
            ul.appendChild(remLi);
          });
          li.appendChild(ul);
        }

        jobList.appendChild(li);
      });
    } catch (err) {
      console.error("Error loading jobs/reminders:", err);
    }
  }

  // Toggle reminder form
  function toggleReminderForm(jobId) {
    const div = document.getElementById(`reminder-form-${jobId}`);
    div.style.display = div.style.display === "none" ? "block" : "none";
  }

  // Save reminder
  function saveReminder(jobId) {
    const reminderDate = document.getElementById(`reminder-date-${jobId}`).value;
    const note = document.getElementById(`reminder-note-${jobId}`).value;

    if (!reminderDate) {
      alert("Please select a date/time!");
      return;
    }

    axios.post("http://localhost:3000/api/reminders", {
      jobId,
      reminderDate,
      note
    }, {
      headers: { Authorization: `Bearer ${token}` }
    })
    .then(() => {
      alert("Reminder set!");
      loadJobs();
    })
    .catch(err => {
      console.error("Reminder error:", err.response?.data || err.message);
      alert("Failed to set reminder");
    });
  }

  // Delete reminder
  function deleteReminder(reminderId) {
    if (!confirm("Delete this reminder?")) return;

    axios.delete(`http://localhost:3000/api/reminders/${reminderId}`, {
      headers: { Authorization: `Bearer ${token}` }
    })
    .then(() => {
      alert("Reminder deleted!");
      loadJobs();
    })
    .catch(err => {
      console.error("Delete reminder error:", err);
      alert("Failed to delete reminder");
    });
  }

  // Save / Update Job
  jobForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const jobId = jobIdInput.value;
    const formData = new FormData(jobForm);

    try {
      if (jobId) {
        await axios.put(`http://localhost:3000/api/jobs/${jobId}`, formData, {
          headers: { Authorization: `Bearer ${token}`, "Content-Type": "multipart/form-data" }
        });
        alert("Job updated!");
      } else {
        await axios.post("http://localhost:3000/api/jobs", formData, {
          headers: { Authorization: `Bearer ${token}`, "Content-Type": "multipart/form-data" }
        });
        alert("Job saved!");
      }
      resetForm();
      loadJobs();
    } catch (err) {
      console.error("Save error:", err.response?.data || err.message);
      alert("Error saving job application");
    }
  });

  function resetForm() {
    jobForm.reset();
    jobIdInput.value = "";
  }

  // Init
  loadJobs();
  </script>
</body>
</html>
